<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tabs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        #map {
            height: 300px;
            width: 100%;
            margin-top: 1rem;
            border-radius: 0.5rem;
        }

        #map-empresas {
            height: 400px;
            width: 100%;
            margin-top: 1rem;
            border-radius: 0.5rem;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="max-w-2xl w-full mx-auto px-4">
        <!-- Botón Volver al Buscador -->
        <div class="mb-4">
            <br />
            <br />
            <button id="volverBuscadorBtn"
                class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded transition">
                ← Volver al buscador
            </button>
        </div>

        <!-- Tabs Navbar -->
        <nav class="flex bg-white shadow rounded-xl mb-4 overflow-hidden border border-gray-200">
            <ul class="flex w-full">
                <li
                    class="select-tab flex-1 text-center cursor-pointer px-4 py-3 font-semibold transition bg-blue-100 text-blue-700 shadow-inner border-r border-gray-200 hover:bg-blue-200 first:rounded-l-xl last:border-none last:rounded-r-xl">
                    Todos
                </li>
                <li
                    class="select-tab flex-1 text-center cursor-pointer px-4 py-3 font-semibold transition hover:bg-blue-50">
                    Top 10 mejores salarios
                </li>
                <li
                    class="select-tab flex-1 text-center cursor-pointer px-4 py-3 font-semibold transition hover:bg-blue-50">
                    Top 10 peores salarios
                </li>
                <li
                    class="select-tab flex-1 text-center cursor-pointer px-4 py-3 font-semibold transition hover:bg-blue-50">
                    Mapa
                </li>
                <li
                    class="select-tab flex-1 text-center cursor-pointer px-4 py-3 font-semibold transition hover:bg-blue-50">
                    Empresas Cercanas
                </li>
            </ul>
        </nav>

        <!-- Tabs Content -->
        <section class="select-content bg-white rounded-xl shadow p-6 border border-gray-200">
            Cargando trabajos...
        </section>
        <section class="select-content bg-white rounded-xl shadow p-6 border border-gray-200 hidden">
            Cargando trabajos...
        </section>
        <section class="select-content bg-white rounded-xl shadow p-6 border border-gray-200 hidden">
            Cargando trabajos...
        </section>
        <section class="select-content bg-white rounded-xl shadow p-6 border border-gray-200 hidden" id="tab4-content">
            <h2 class="text-lg font-semibold mb-2">Ubicación Actual</h2>
            <div id="map"></div>
        </section>
        <section class="select-content bg-white rounded-xl shadow p-6 border border-gray-200 hidden" id="tab5-content">
            <h2 class="text-lg font-semibold mb-2">Ubicación propia y empresas cercanas</h2>
            <div id="map-empresas"></div>
            <p id="mensaje-empresas" class="mt-4 text-gray-700"></p>
        </section>
    </div>

    <!-- Leaflet JS para el mapa -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <script>
        // Botón para regresar al buscador
        document.getElementById('volverBuscadorBtn').addEventListener('click', () => {
            window.location.href = 'buscador.html';
        });

        let mapa = null;

        function mostrarMapa(lat, lon) {
            if (mapa) {
                mapa.remove();
            }

            mapa = L.map('map').setView([lat, lon], 13);

            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(mapa);

            L.marker([lat, lon])
                .addTo(mapa)
                .bindPopup('Estás aquí')
                .openPopup();
        }

        function limpiarMapa() {
            if (mapa) {
                mapa.remove();
                mapa = null;
            }
            document.getElementById('map').innerHTML = '';
        }

        function pedirUbicacion() {
            if (!navigator.geolocation) {
                alert('Geolocalización no soportada por tu navegador.');
                limpiarMapa();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    mostrarMapa(lat, lon);
                },
                (err) => {
                    alert(`Error obteniendo ubicación: ${err.message}`);
                    limpiarMapa();
                }
            );
        }

        // Variable global para guardar trabajos cargados
        let trabajos = [];

        // Función para cargar datos JSON desde backend
        async function cargarTrabajos() {
            try {
                const res = await fetch('http://localhost:3000/output/resultadosCompuTrabajo.json');
                if (!res.ok) throw new Error('Error cargando trabajos');
                trabajos = await res.json();
                mostrarTrabajos(trabajos, contents[0]);
            } catch (e) {
                console.error(e);
                trabajos = [];
                contents[0].innerHTML = '<p class="text-red-500">No se pudieron cargar los trabajos.</p>';
            }
        }

        // Función para extraer número del salario (ajusta según formato real)
        function extraerSalario(texto) {
            if (!texto) return 0;
            const numeros = texto.match(/\d+/g);
            if (!numeros) return 0;
            return Math.max(...numeros.map(n => parseInt(n)));
        }

        // Función para mostrar trabajos en un contenedor HTML
        function mostrarTrabajos(trabajosFiltrados, contenedor) {
            if (!trabajosFiltrados.length) {
                contenedor.innerHTML = '<p>No hay trabajos para mostrar.</p>';
                return;
            }
            let html = '';
            trabajosFiltrados.forEach(t => {
                html += `
          <article class="mb-4 border rounded p-4 shadow-sm bg-gray-50">
            <h3 class="font-bold text-lg">${t.titulo}</h3>
            <p><strong>Empresa:</strong> ${t.empresa}</p>
            <p><strong>Salario:</strong> ${t.salario}</p>
            <p><strong>Ubicación:</strong> ${t.ubicacion}</p>
            <p>${t.descripcion}</p>
          </article>
        `;
            });
            contenedor.innerHTML = html;
        }

        // Cache para geocodificación
        const cacheGeocoding = {};

        async function geocodificar(direccion) {
            if (cacheGeocoding[direccion]) return cacheGeocoding[direccion];

            const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(direccion);
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('Error en la petición de geocodificación');
                const data = await res.json();
                if (!data.length) return null;
                const coords = {
                    lat: parseFloat(data[0].lat),
                    lon: parseFloat(data[0].lon)
                };
                cacheGeocoding[direccion] = coords;
                return coords;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // Variable para guardar códigos postales
        let codigosPostalesData = null;

        // Cargar JSON externo de códigos postales
        async function cargarCodigosPostales() {
            try {
                const response = await fetch('output/codigosPostales.json');
                if (!response.ok) throw new Error('No se pudo cargar codigosPostales.json');
                codigosPostalesData = await response.json();
                console.log('Códigos postales cargados:', codigosPostalesData);
            } catch (error) {
                console.error('Error cargando codigosPostales.json', error);
            }
        }

        // Obtener código postal según estado mencionado en dirección
        function obtenerCodigoPostalPorDireccion(direccion) {
            if (!codigosPostalesData) return null;

            const direccionLower = direccion.toLowerCase();

            for (const estado in codigosPostalesData) {
                if (direccionLower.includes(estado.toLowerCase())) {
                    const codigosEstado = codigosPostalesData[estado];
                    const codigoObj = codigosEstado[Math.floor(Math.random() * codigosEstado.length)];
                    return codigoObj.codigoPostal;
                }
            }
            return null;
        }

        let mapaEmpresas = null;

        async function mostrarMapaEmpresas() {
            const divMensaje = document.getElementById('mensaje-empresas');
            divMensaje.textContent = 'Obteniendo ubicación...';

            await cargarCodigosPostales();

            if (!navigator.geolocation) {
                divMensaje.textContent = "Geolocalización no soportada por tu navegador.";
                console.error("Geolocalización no soportada");
                return;
            }

            navigator.geolocation.getCurrentPosition(async pos => {
                const latUsuario = pos.coords.latitude;
                const lonUsuario = pos.coords.longitude;
                console.log("Ubicación usuario:", latUsuario, lonUsuario);

                divMensaje.textContent = 'Cargando mapa y empresas cercanas...';

                if (mapaEmpresas) {
                    mapaEmpresas.remove();
                    mapaEmpresas = null;
                }

                mapaEmpresas = L.map('map-empresas').setView([latUsuario, lonUsuario], 12);

                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(mapaEmpresas);

                L.marker([latUsuario, lonUsuario])
                    .addTo(mapaEmpresas)
                    .bindPopup('Tu ubicación actual')
                    .openPopup();

                let empresasContadas = 0;

                for (const trabajo of trabajos) {
                    if (!trabajo.ubicacion) {
                        console.warn("Trabajo sin ubicación:", trabajo);
                        continue;
                    }

                    let direccionParaBuscar = trabajo.ubicacion;
                    if (direccionParaBuscar.includes(' - ')) {
                        direccionParaBuscar = direccionParaBuscar.split(' - ').pop().trim();
                    }

                    const codigoPostalAsignado = obtenerCodigoPostalPorDireccion(trabajo.ubicacion);

                    if (codigoPostalAsignado) {
                        direccionParaBuscar += `, CP ${codigoPostalAsignado}, México`;
                    } else {
                        direccionParaBuscar += ', México';
                    }

                    console.log("Geocodificando dirección:", direccionParaBuscar);

                    const coords = await geocodificar(direccionParaBuscar);
                    if (coords) {
                        console.log("Coordenadas obtenidas:", coords);
                        L.marker([coords.lat, coords.lon])
                            .addTo(mapaEmpresas)
                            .bindPopup(`<strong>${trabajo.titulo}</strong><br><em>${trabajo.empresa}</em><br>${direccionParaBuscar}`);
                        empresasContadas++;
                    } else {
                        console.warn("No se obtuvieron coords para:", direccionParaBuscar);
                    }
                }

                console.log(`Total empresas mostradas: ${empresasContadas}`);
                divMensaje.textContent = `Mostrando ${empresasContadas} empresa(s) cercana(s).`;

            }, err => {
                console.error('Error obteniendo ubicación del usuario:', err);
                divMensaje.textContent = "No se pudo obtener la ubicación.";
            });
        }

        const tabs = document.querySelectorAll('.select-tab');
        const contents = document.querySelectorAll('.select-content');

        // Escuchar clicks en tabs para filtrar y mostrar trabajos
        tabs.forEach((tab, index) => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => {
                    t.classList.remove('bg-blue-100', 'text-blue-700', 'shadow-inner');
                    t.classList.add('hover:bg-blue-50');
                });
                tab.classList.add('bg-blue-100', 'text-blue-700', 'shadow-inner');
                tab.classList.remove('hover:bg-blue-50');

                contents.forEach(c => c.classList.add('hidden'));
                contents[index].classList.remove('hidden');

                if (index === 0) {
                    // Mostrar todos
                    mostrarTrabajos(trabajos, contents[0]);
                } else if (index === 1) {
                    // Top 10 mejores salarios
                    const mejores = trabajos
                        .filter(t => t.salario && /\d/.test(t.salario))
                        .sort((a, b) => extraerSalario(b.salario) - extraerSalario(a.salario))
                        .slice(0, 10);
                    mostrarTrabajos(mejores, contents[1]);
                } else if (index === 2) {
                    // Top 10 peores salarios
                    const peores = trabajos
                        .filter(t => t.salario && /\d/.test(t.salario))
                        .sort((a, b) => extraerSalario(a.salario) - extraerSalario(b.salario))
                        .slice(0, 10);
                    mostrarTrabajos(peores, contents[2]);
                } else if (index === 3) {
                    pedirUbicacion();
                } else if (index === 4) {
                    mostrarMapaEmpresas();
                }
            });
        });

        // Cargar datos cuando se carga la página
        window.addEventListener('DOMContentLoaded', () => {
            cargarTrabajos();
            tabs[0].click(); // Seleccionar tab "Todos" al inicio
        });
    </script>
</body>

</html>