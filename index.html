<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tabs con Leaflet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        #map {
            height: 300px;
            width: 100%;
            margin-top: 1rem;
            border-radius: 0.5rem;
        }

        #map-empresas {
            height: 400px;
            width: 100%;
            margin-top: 1rem;
            border-radius: 0.5rem;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="max-w-2xl w-full">
        <!-- Botón Volver -->
        <div class="mb-4">
            <button id="volverBuscadorBtn"
                class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded transition">
                ← Volver al buscador
            </button>
        </div>

        <!-- Tabs Navbar -->
        <nav class="flex bg-white shadow rounded-xl mb-4 overflow-hidden border border-gray-200">
            <ul class="flex w-full">
                <li
                    class="select-tab flex-1 text-center cursor-pointer px-4 py-3 font-semibold transition bg-blue-100 text-blue-700 shadow-inner border-r border-gray-200 hover:bg-blue-200 first:rounded-l-xl last:border-none last:rounded-r-xl">
                    Todos
                </li>
                <li
                    class="select-tab flex-1 text-center cursor-pointer px-4 py-3 font-semibold transition hover:bg-blue-50">
                    Top 10 mejores salarios
                </li>
                <li
                    class="select-tab flex-1 text-center cursor-pointer px-4 py-3 font-semibold transition hover:bg-blue-50">
                    Top 10 peores salarios
                </li>
                <li
                    class="select-tab flex-1 text-center cursor-pointer px-4 py-3 font-semibold transition hover:bg-blue-50">
                    Mapa
                </li>
                <li
                    class="select-tab flex-1 text-center cursor-pointer px-4 py-3 font-semibold transition hover:bg-blue-50">
                    Empresas Cercanas
                </li>
            </ul>
        </nav>

        <!-- Tabs Contenido  -->
        <section class="select-content bg-white rounded-xl shadow p-6 border border-gray-200">
            Cargando trabajos...
        </section>
        <section class="select-content bg-white rounded-xl shadow p-6 border border-gray-200 hidden">
            Cargando trabajos...
        </section>
        <section class="select-content bg-white rounded-xl shadow p-6 border border-gray-200 hidden">
            Cargando trabajos...
        </section>
        <section class="select-content bg-white rounded-xl shadow p-6 border border-gray-200 hidden" id="tab4-content">
            <h2 class="text-lg font-semibold mb-2">Ubicación Actual</h2>
            <div id="map"></div>
        </section>
        <section class="select-content bg-white rounded-xl shadow p-6 border border-gray-200 hidden" id="tab5-content">
            <h2 class="text-lg font-semibold mb-2">Ubicación propia y empresas cercanas</h2>
            <div id="map-empresas"></div>
            <p id="mensaje-empresas" class="mt-4 text-gray-700"></p>
        </section>
    </div>

    <!-- Leaflet JS el scrip de la libreria del mapa  -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        // Variables globales
        let mapa = null;
        let mapaEmpresas = null;
        let trabajos = [];
        let zonasCoordenadas = {};

        // Cargo las coordenadas de mi archivo calles.json haciendo un fetch a mi servidor local
        async function cargarZonasCoordenadas() {
            try {
                const res = await fetch('http://localhost:3000/output/calles.json');
                if (!res.ok) throw new Error('Error cargando coordenadas de zonas');
                zonasCoordenadas = await res.json();
                console.log('Coordenadas de zonas cargadas:', zonasCoordenadas);
            } catch (e) {
                console.error('Error al cargar coordenadas de zonas:', e);
                zonasCoordenadas = {};
            }
        }

        // Botón de Volver para que regrese al buscadoer
        document.getElementById('volverBuscadorBtn').addEventListener('click', () => {
            window.location.href = 'buscador.html';
        });

        // Aqui es donde Muestro el mapa de ubicación actual del usuario con la libreria de leaflet
        function mostrarMapa(lat, lon) {
            if (mapa) {
                mapa.remove();
            }
            mapa = L.map('map').setView([lat, lon], 13);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
            }).addTo(mapa);
            L.marker([lat, lon])
                .addTo(mapa)
                .bindPopup('Estás aquí')
                .openPopup();
        }

        // Limpio el mapa si es necesario para que no me genere problemas al mostrar la ubicación
        function limpiarMapa() {
            if (mapa) {
                mapa.remove();
                mapa = null;
            }
            document.getElementById('map').innerHTML = '';
        }

        // Pido el permiso de la ubicación al usuario y lo muestro en el mapa
        function pedirUbicacion() {
            if (!navigator.geolocation) {
                alert('Geolocalización no soportada por tu navegador.');
                limpiarMapa();
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    mostrarMapa(pos.coords.latitude, pos.coords.longitude);
                },
                (err) => {
                    alert(`Error obteniendo ubicación: ${err.message}`);
                    limpiarMapa();
                }
            );
        }

        // Cargo el archivo JSON de resultados de trabajos de mi scraping
        async function cargarTrabajos() {
            try {
                const res = await fetch(
                    'http://localhost:3000/output/resultadosCompuTrabajo.json'
                );
                if (!res.ok) throw new Error('Error cargando trabajos');
                trabajos = await res.json();
                mostrarTrabajos(trabajos, contents[0]);
            } catch (e) {
                console.error(e);
                trabajos = [];
                contents[0].innerHTML =
                    '<p class="text-red-500">No se pudieron cargar los trabajos.</p>';
            }
        }

        // trato de extraer el salario mayor de mis trasbajos
        function extraerSalario(texto) {
            if (!texto) return 0;
            const numeros = texto.match(/\d+/g);
            if (!numeros) return 0;
            return Math.max(...numeros.map((n) => parseInt(n)));
        }

        // Muestro la lista de trabajos en el contenedor de mis tabs
        function mostrarTrabajos(trabajosFiltrados, contenedor) {
            if (!trabajosFiltrados.length) {
                contenedor.innerHTML = '<p>No hay trabajos para mostrar.</p>';
                return;
            }
            let html = '';
            trabajosFiltrados.forEach((t) => {
                html += `
          <article class="mb-4 border rounded p-4 shadow-sm bg-gray-50">
            <h3 class="font-bold text-lg">${t.titulo}</h3>
            <p><strong>Empresa:</strong> ${t.empresa}</p>
            <p><strong>Salario:</strong> ${t.salario}</p>
            <p><strong>Ubicación:</strong> ${t.ubicacion}</p>
            <p>${t.descripcion}</p>
          </article>
        `;
            });
            contenedor.innerHTML = html;
        }

        // Mostrar mapa con marcadores de empresas según coordenadas fijas por alcaldía (tab Empresas Cercanas)
        async function mostrarMapaEmpresas() {
            const divMensaje = document.getElementById('mensaje-empresas');
            divMensaje.textContent = 'Obteniendo ubicación...';

            if (!navigator.geolocation) {
                divMensaje.textContent = 'Geolocalización no soportada por tu navegador.';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const latUsuario = pos.coords.latitude;
                    const lonUsuario = pos.coords.longitude;

                    divMensaje.textContent = 'Cargando mapa y empresas cercanas...';

                    if (mapaEmpresas) {
                        mapaEmpresas.remove();
                        mapaEmpresas = null;
                    }

                    mapaEmpresas = L.map('map-empresas').setView([latUsuario, lonUsuario], 12);
                    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors',
                    }).addTo(mapaEmpresas);

                    L.marker([latUsuario, lonUsuario])
                        .addTo(mapaEmpresas)
                        .bindPopup('Tu ubicación actual')
                        .openPopup();

                    let empresasContadas = 0;

                    trabajos.forEach((trabajo) => {
                        if (!trabajo.ubicacion) return;

                        // Extraemos zona de la dirección (lo que está después del '-')
                        let zona = trabajo.ubicacion;
                        if (zona.includes(' - ')) {
                            zona = zona.split(' - ')[1].trim().toLowerCase();
                        } else {
                            zona = zona.toLowerCase();
                        }

                        let coords = null;
                        for (const claveZona in zonasCoordenadas) {
                            if (zona.includes(claveZona)) {
                                coords = zonasCoordenadas[claveZona];
                                break;
                            }
                        }

                        if (
                            coords &&
                            typeof coords.lat === 'number' &&
                            typeof coords.lon === 'number'
                        ) {
                            L.marker([coords.lat, coords.lon])
                                .addTo(mapaEmpresas)
                                .bindPopup(
                                    `<strong>${trabajo.titulo}</strong><br><em>${trabajo.empresa}</em><br>${trabajo.ubicacion}`
                                );
                            empresasContadas++;
                        } else {
                            console.warn('No hay coordenadas para la zona:', zona);
                        }
                    });

                    divMensaje.textContent = `Mostrando ${empresasContadas} empresa(s) cercana(s).`;
                },
                (err) => {
                    console.error('Error obteniendo ubicación del usuario:', err);
                    divMensaje.textContent = 'No se pudo obtener la ubicación.';
                }
            );
        }

        const tabs = document.querySelectorAll('.select-tab');
        const contents = document.querySelectorAll('.select-content');

        tabs.forEach((tab, index) => {
            tab.addEventListener('click', () => {
                tabs.forEach((t) => {
                    t.classList.remove('bg-blue-100', 'text-blue-700', 'shadow-inner');
                    t.classList.add('hover:bg-blue-50');
                });
                tab.classList.add('bg-blue-100', 'text-blue-700', 'shadow-inner');
                tab.classList.remove('hover:bg-blue-50');

                contents.forEach((c) => c.classList.add('hidden'));
                contents[index].classList.remove('hidden');

                switch (index) {
                    case 0:
                        mostrarTrabajos(trabajos, contents[0]);
                        break;
                    case 1:
                        const mejores = trabajos
                            .filter((t) => t.salario && /\d/.test(t.salario))
                            .sort(
                                (a, b) =>
                                    extraerSalario(b.salario) - extraerSalario(a.salario)
                            )
                            .slice(0, 10);
                        mostrarTrabajos(mejores, contents[1]);
                        break;
                    case 2:
                        const peores = trabajos
                            .filter((t) => t.salario && /\d/.test(t.salario))
                            .sort(
                                (a, b) =>
                                    extraerSalario(a.salario) - extraerSalario(b.salario)
                            )
                            .slice(0, 10);
                        mostrarTrabajos(peores, contents[2]);
                        break;
                    case 3:
                        pedirUbicacion();
                        break;
                    case 4:
                        mostrarMapaEmpresas();
                        break;
                }
            });
        });

        window.addEventListener('DOMContentLoaded', async () => {
            await cargarZonasCoordenadas();
            await cargarTrabajos();
            tabs[0].click();
        });
    </script>
</body>

</html>